# ================================================================
# UBUNTU SERVER - HIZLI GÃœNCELLEME (dbt restart fix)
# ================================================================
# Tarih: 2026-01-24 23:30
# Sorun: dbt container sÃ¼rekli restart oluyor
# Ã‡Ã¶zÃ¼m: GitHub'dan son versiyonu Ã§ek ve gÃ¼ncelle
# ================================================================

# ADIM 1: GitHub'dan son versiyonu Ã§ek
cd ~/erp-analiz/erp_analiz_paketi
git pull

# ADIM 2: GÃ¼ncellenen dosyayÄ± kopyala
cp docker-compose.minimal.yml ~/erp-analiz/SIRKET$/docker-compose.yml

# ADIM 3: dbt container'Ä±nÄ± yeniden oluÅŸtur
cd ~/erp-analiz/SIRKET$
docker compose stop dbt
docker compose rm -f dbt
docker compose up -d dbt

# ADIM 4: Kontrol et
docker compose ps

# Beklenen Ã§Ä±ktÄ±:
# CabriBT_dbt   ghcr.io/dbt-labs/dbt-core:latest   Up

# ================================================================
# SORUN DÃœZELDÄ° MÄ°? DEVAM ET!
# ================================================================

# ADIM 5: .env dosyasÄ±nÄ± dÃ¼zenle (ERP baÄŸlantÄ± bilgileri)
nano .env

# DÃ¼zenlenecek satÄ±rlar:
#
# ERP_DB_HOST=192.168.1.100           # ERP veritabanÄ± IP adresi
# ERP_DB_NAME=WORKCUBE_CABRIBISIKLET  # ERP veritabanÄ± adÄ±
# ERP_DB_USER=raporlama               # ERP kullanÄ±cÄ± adÄ±
# ERP_DB_PASSWORD=sifre123            # ERP ÅŸifresi
#
# WC_BASE_SCHEMA=workcube_prod        # Workcube ÅŸema adÄ±
# WC_PERIOD_YEAR=2026                 # DÃ¶nem yÄ±lÄ±
# WC_COMPANY_ID=1                     # Åžirket ID
#
# Kaydet: Ctrl+X, Y, Enter

# ================================================================
# VERÄ° AKIÅžI TESTÄ°
# ================================================================

# ADIM 6: ERP'den ClickHouse'a veri Ã§ekme testi
docker exec CabriBT_dbt python /usr/app/scripts/erp_to_clickhouse_v2.py

# Beklenen Ã§Ä±ktÄ±:
# âœ… ERP baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±
# âœ… Veri Ã§ekildi: X satÄ±r
# âœ… ClickHouse'a yazÄ±ldÄ±

# ADIM 7: dbt transformasyonlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±r
docker exec CabriBT_dbt dbt run

# Beklenen Ã§Ä±ktÄ±:
# Running with dbt=1.x.x
# Found X models, Y tests, Z sources
# Completed successfully

# ADIM 8: ClickHouse'da veriyi kontrol et
docker exec -it CabriBT_clickhouse clickhouse-client

# ClickHouse iÃ§inde:
SHOW TABLES;
SELECT COUNT(*) FROM erp_analytics.satislar;
exit

# ================================================================
# SUPERSET'TE CLICKHOUSE BAÄžLANTISI
# ================================================================

# TarayÄ±cÄ±dan Superset'i aÃ§:
# http://UBUNTU-IP:8088

# GiriÅŸ:
# KullanÄ±cÄ±: admin
# Åžifre: admin123 (veya .env'de belirlediÄŸiniz)

# Superset'te:
# 1. Settings > Database Connections > + Database
# 2. ClickHouse seÃ§
# 3. BaÄŸlantÄ± bilgileri:
#    Host: clickhouse
#    Port: 8123
#    Database: erp_analytics
#    Username: default
#    Password: (boÅŸ bÄ±rak)
# 4. Test Connection
# 5. Connect

# ================================================================
# OTOMATIK VERÄ° Ã‡EKME AYARI (Ofelia)
# ================================================================

# ofelia.ini dosyasÄ±nÄ± kontrol et
cat ofelia.ini

# Ofelia loglarÄ±nÄ± izle
docker logs CabriBT_scheduler -f

# ZamanlanmÄ±ÅŸ gÃ¶revler Ã§alÄ±ÅŸÄ±yor mu?
# Ofelia her gece saat 02:00'da otomatik veri Ã§ekecek

# ================================================================
# YARINLI KOMUTLAR
# ================================================================

# TÃ¼m servislerin durumu
docker compose ps

# LoglarÄ± izle
docker compose logs -f

# Belirli bir servisin logu
docker compose logs clickhouse -f
docker compose logs superset -f
docker compose logs dbt -f

# Servisi yeniden baÅŸlat
docker compose restart dbt

# TÃ¼m servisleri yeniden baÅŸlat
docker compose restart

# Durdur
docker compose down

# BaÅŸlat
docker compose up -d

# Manuel veri Ã§ekme
docker exec CabriBT_dbt python /usr/app/scripts/erp_to_clickhouse_v2.py

# Sistem kaynaklarÄ±
docker stats
htop
df -h

# ================================================================
# BAÅžARILAR! ðŸŽ‰
# ================================================================
