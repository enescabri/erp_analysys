version: "3.8"

services:
  # === ANALİTİK DEPO (Hız Motoru) ===
  clickhouse:
    image: clickhouse/clickhouse-server:23.8-alpine
    container_name: ${MUSTERI_ADI}_clickhouse
    restart: unless-stopped
    ports:
      - "8123:8123"
    volumes:
      - ./data/clickhouse:/var/lib/clickhouse
    environment:
      - CLICKHOUSE_DB=erp_analytics
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  # === ORTAK METADATA VERİTABANI ===
  postgres:
    image: postgres:15-alpine
    container_name: ${MUSTERI_ADI}_postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=${SECRET_KEY}
      - POSTGRES_DB=shared_metadata
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./init_scripts:/docker-entrypoint-initdb.d

  # === REDIS ÖNBELLEK ===
  redis:
    image: redis:7-alpine
    container_name: ${MUSTERI_ADI}_redis
    restart: unless-stopped

  # === DBT (Veri Dönüşüm Motoru) ===
  dbt:
    image: ghcr.io/dbt-labs/dbt-core:1.7.0
    container_name: ${MUSTERI_ADI}_dbt
    volumes:
      - ./dbt_project:/usr/app
      - ./dbt_profiles:/root/.dbt
    working_dir: /usr/app
    environment:
      - DBT_PROFILES_DIR=/root/.dbt
    depends_on:
      - clickhouse
    entrypoint: ["tail", "-f", "/dev/null"]  # Manuel çalıştırma için beklemede tut

  # === AIRFLOW (Veri Taşıma Orkestratörü) ===
  airflow:
    image: apache/airflow:2.7.1-python3.10
    container_name: ${MUSTERI_ADI}_airflow
    restart: unless-stopped
    environment:
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://admin:${SECRET_KEY}@postgres/shared_metadata
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__CORE__LOAD_EXAMPLES=false
      - AIRFLOW__WEBSERVER__SECRET_KEY=${SECRET_KEY}
      - _PIP_ADDITIONAL_REQUIREMENTS=clickhouse-connect pymssql cx_Oracle psycopg2-binary
    volumes:
      - ./dags:/opt/airflow/dags
      - ./data/airflow_logs:/opt/airflow/logs
    ports:
      - "8080:8080"
    depends_on:
      - postgres
      - clickhouse
    command: >
      bash -c "
      airflow db init &&
      airflow users create --username admin --firstname Admin --lastname User --role Admin --email admin@${DOMAIN} --password ${SUPERSET_ADMIN_PASS} || true &&
      airflow webserver & airflow scheduler"

  # === SUPERSET (Görselleştirme) ===
  superset:
    image: apache/superset:3.0.0
    container_name: ${MUSTERI_ADI}_superset
    restart: unless-stopped
    ports:
      - "8088:8088"
    environment:
      - SUPERSET_CONFIG_PATH=/app/pythonpath/superset_config.py
      - SECRET_KEY=${SECRET_KEY}
    volumes:
      - ./superset_config.py:/app/pythonpath/superset_config.py:ro
      - ./data/superset_home:/app/superset_home
    depends_on:
      - postgres
      - redis
      - clickhouse
    command: >
      bash -c "
      pip install clickhouse-connect pymssql cx_Oracle psycopg2-binary &&
      superset db upgrade &&
      superset fab create-admin --username admin --firstname Admin --lastname User --email admin@${DOMAIN} --password ${SUPERSET_ADMIN_PASS} || true &&
      superset init &&
      gunicorn --bind 0.0.0.0:8088 --workers 4 --timeout 120 --limit-request-line 0 --limit-request-field_size 0 'superset.app:create_app()'"
